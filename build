#!/bin/sh

# Exit immediately on error
set -e

echo "FROM geerlingguy/docker-${distro}-ansible:latest" > tests/Dockerfile

# Build container
container_tag=${distro}:ansible
sudo docker build \
  --rm=true \
  --tag=${container_tag} tests

# Run container in detached state
id_file=$(mktemp)
sudo docker run \
  --detach \
  --volume="${PWD}":/etc/ansible/roles/role_under_test:ro \
  ${run_opts} \
  ${container_tag} ${init} > "${id_file}"
container_id="$(cat $id_file)"
echo "Container ID:" "${container_id}"

# Install dependencies.
sudo docker exec "${container_id}" \
  ansible-galaxy install \
    -r /etc/ansible/roles/role_under_test/tests/requirements.yml

# Ansible syntax check.
sudo docker exec "${container_id}" \
  env TERM=xterm \
  ansible-playbook /etc/ansible/roles/role_under_test/tests/test.yml \
    --syntax-check

# Run ansible-lint (outside of docker container).
ansible-lint tests/test.yml

# Check that role installs successfully.
sudo docker exec "${container_id}" \
  env TERM=xterm \
  ansible-playbook /etc/ansible/roles/role_under_test/tests/test.yml


# Get container's IP address.
print_ip_python=$(echo "import sys, json;
print json.load(sys.stdin)[0]['NetworkSettings']['IPAddress']")
container_ip=$(sudo docker inspect "${container_id}" | \
    python -c "${print_ip_python}")
echo "Container IP Address:" "${container_ip}"

# Check that GreenPiThumb is serving.
curl -s "${container_ip}"  \
  | grep "GreenPiThumb" && \
  (echo 'Landing page test: pass' && exit 0) || \
  (echo 'Landing page test: fail' && exit 1)

# Clean up
sudo docker stop "${container_id}"
sudo docker rm "${container_id}"
rm tests/Dockerfile
